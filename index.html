<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunch Splitter</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #333; display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        #auth-screen input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; margin-bottom: 10px; }
        #auth-screen button { padding: 10px 20px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 5px; font-size: 16px; }

        /* Main App */
        #app { display: none; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2, h3 { margin-top: 0; }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; align-items: center; }
        .row input { margin-bottom: 5px; }
        
        button { cursor: pointer; background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        button.secondary { background: #6b7280; }
        button.danger { background: #ef4444; }
        button.add-btn { background: #10b981; width: auto; margin-bottom: 15px; }
        
        .person-entry { display: flex; gap: 10px; margin-bottom: 10px; }
        .remove-x { background: transparent; color: red; width: auto; padding: 0 10px; margin: 0; font-size: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
        .amount { font-family: monospace; font-weight: bold; }
        .settlement { background: #dbeafe; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- Security Overlay -->
    <div id="auth-screen">
        <h2 style="color:white">Enter Access Code</h2>
        <input type="password" id="passcode" placeholder="Password">
        <button onclick="checkPass()">Enter</button>
    </div>

    <!-- Main Application -->
    <div id="app">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>Lunch Splitter üçî</h1>
            <div>
                <button class="secondary" onclick="exportData()" style="width:auto; font-size:12px;">üíæ Save/Export</button>
                <button class="secondary" onclick="importData()" style="width:auto; font-size:12px;">üìÇ Load</button>
            </div>
        </div>

        <!-- Section 1: Add New Meal -->
        <div class="card">
            <h2>Add New Meal</h2>
            <label>Who Paid?</label>
            <input type="text" id="payerName" placeholder="e.g., Alice">

            <h3>Orders</h3>
            <div id="orders-list"></div>
            <button class="add-btn" onclick="addOrderRow()">+ Add Person</button>

            <label>Extra Fees / Discount (+ for Tax/Tip, - for Discount)</label>
            <input type="number" id="extraFee" value="0" placeholder="0">

            <button onclick="calculateAndCommit()">Commit Meal</button>
        </div>

        <!-- Section 2: Ledger History -->
        <div class="card">
            <h2>History</h2>
            <div id="history-log" style="max-height: 200px; overflow-y: auto; font-size: 0.9em; color: #555;">
                <p>No meals added yet.</p>
            </div>
            <button class="danger" onclick="clearAll()" style="margin-top:10px;">Reset All Data</button>
        </div>

        <!-- Section 3: Final Settlement -->
        <div class="card">
            <h2>üí∞ Who Pays Who</h2>
            <div id="settlement-plan"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const APP_PASSWORD = "pizza"; // <--- CHANGE THIS PASSWORD HERE

        // --- AUTHENTICATION ---
        function checkPass() {
            const input = document.getElementById('passcode').value;
            if (input === APP_PASSWORD) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                loadData();
            } else {
                alert("Wrong password!");
            }
        }

        // --- STATE MANAGEMENT ---
        let ledger = []; // Stores all transactions

        function addOrderRow() {
            const div = document.createElement('div');
            div.className = 'person-entry';
            div.innerHTML = `
                <input type="text" placeholder="Name" class="eater-name">
                <input type="number" placeholder="Price" class="eater-price">
                <button class="remove-x" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById('orders-list').appendChild(div);
        }

        function calculateAndCommit() {
            const payer = document.getElementById('payerName').value.trim();
            const extra = parseFloat(document.getElementById('extraFee').value) || 0;
            const rows = document.querySelectorAll('.person-entry');
            
            if (!payer) return alert("Please enter who paid.");
            if (rows.length === 0) return alert("Add people who ate.");

            let subtotal = 0;
            let consumers = [];

            // 1. Calculate Subtotal
            rows.forEach(row => {
                const name = row.querySelector('.eater-name').value.trim();
                const price = parseFloat(row.querySelector('.eater-price').value) || 0;
                if (name && price > 0) {
                    subtotal += price;
                    consumers.push({ name, basePrice: price });
                }
            });

            if (subtotal === 0) return alert("Total price cannot be zero.");

            // 2. Calculate Ratio and Actual Cost
            const totalWithFee = subtotal + extra;
            const ratio = totalWithFee / subtotal;

            let transaction = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                payer: payer,
                total: totalWithFee,
                details: []
            };

            consumers.forEach(p => {
                // Determine how much this person actually owes based on ratio
                const finalAmount = p.basePrice * ratio;
                transaction.details.push({
                    name: p.name,
                    amount: finalAmount
                });
            });

            // 3. Save to Ledger
            ledger.push(transaction);
            saveData();
            renderHistory();
            calculateSettlement();
            
            // Clear inputs
            document.getElementById('orders-list').innerHTML = '';
            document.getElementById('extraFee').value = 0;
            addOrderRow(); // Add one empty row back
            alert(`Meal added! Total: ${totalWithFee.toFixed(2)}`);
        }

        function calculateSettlement() {
            let balances = {};

            // Initialize balances
            ledger.forEach(t => {
                // Payer gets positive balance (people owe them)
                balances[t.payer] = (balances[t.payer] || 0) + t.total;
                
                // Consumers get negative balance (they owe money)
                t.details.forEach(d => {
                    balances[d.name] = (balances[d.name] || 0) - d.amount;
                });
            });

            // Separate into Debtors (-) and Creditors (+)
            let debtors = [];
            let creditors = [];

            for (const [person, amount] of Object.entries(balances)) {
                const val = Math.round(amount * 100) / 100; // Round to 2 decimals
                if (val < -0.01) debtors.push({ name: person, amount: val }); // Negative
                if (val > 0.01) creditors.push({ name: person, amount: val }); // Positive
            }

            // Sort by magnitude to optimize matching
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let html = '<table><tr><th>Sender</th><th>Receiver</th><th>Amount</th></tr>';

            // Greedy algorithm to settle debts
            let i = 0; // debtor index
            let j = 0; // creditor index

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];

                // The amount to settle is the minimum of what debtor owes and creditor is owed
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                
                html += `<tr>
                    <td>${debtor.name}</td>
                    <td>${creditor.name}</td>
                    <td class="amount">$${amount.toFixed(2)}</td>
                </tr>`;

                // Adjust balances
                debtor.amount += amount;
                creditor.amount -= amount;

                // Move indices if settled (using small epsilon for float errors)
                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }
            html += '</table>';

            if (debtors.length === 0 && creditors.length === 0) {
                html = "<p>All settled up! No debts.</p>";
            }

            document.getElementById('settlement-plan').innerHTML = html;
        }

        function renderHistory() {
            const container = document.getElementById('history-log');
            if (ledger.length === 0) {
                container.innerHTML = "<p>No meals added yet.</p>";
                return;
            }
            let html = '';
            ledger.slice().reverse().forEach(t => {
                html += `<div style="border-bottom:1px solid #ddd; padding:5px 0;">
                    <strong>${t.date}</strong>: ${t.payer} paid $${t.total.toFixed(2)}
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- STORAGE & EXPORT ---
        function saveData() {
            localStorage.setItem('lunchLedger', JSON.stringify(ledger));
        }

        function loadData() {
            const saved = localStorage.getItem('lunchLedger');
            if (saved) {
                ledger = JSON.parse(saved);
                renderHistory();
                calculateSettlement();
            }
            addOrderRow(); // Ensure one empty input exists on load
        }

        function clearAll() {
            if(confirm("Are you sure? This deletes all history.")) {
                ledger = [];
                saveData();
                renderHistory();
                calculateSettlement();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ledger));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "lunch_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = readerEvent => {
                    try {
                        const content = readerEvent.target.result;
                        ledger = JSON.parse(content);
                        saveData();
                        renderHistory();
                        calculateSettlement();
                        alert("Data loaded successfully!");
                    } catch (err) {
                        alert("Invalid file");
                    }
                }
            }
            input.click();
        }
    </script>
</body>
</html>
